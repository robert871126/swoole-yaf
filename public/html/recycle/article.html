<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="renderer" content="webkit">
	<meta http-equiv="Cache-Control" content="no-siteapp" />
	<title>微校邦-资讯管理</title>
	<meta name="keywords" content="">
	<meta name="description" content="">

	<link rel="shortcut icon" href="favicon.ico">
	<link href="/statics/css/bootstrap.min.css?v=3.3.5" rel="stylesheet">
	<link href="/statics/css/font-awesome.min.css?v=4.4.0" rel="stylesheet">
	<link href="/statics/css/animate.min.css" rel="stylesheet">
	<link href="/statics/css/style.min.css?v=4.0.0" rel="stylesheet">
	<link href="/statics/css/custom.css" rel="stylesheet">

	<script src="/statics/js/jquery.min.js?v=2.1.4"></script>
	<script src="/statics/js/common.js"></script>
	<script src="/statics/js/plugins/layer/laytpl/laytpl.js"></script>
	<script src="/statics/js/plugins/layer/laypage/laypage.js"></script>
</head>

<body class="gray-bg">
	<div class="wrapper wrapper-content  animated fadeInRight blog">
		<div class="row">
			<div class="col-md-12">
				<div class="search-box">
					<div class="search-box-left">
						<div class="input-group">
	                        <input type="text" class="form-control" name="keywords"> <span class="input-group-btn"> <button type="button" class="btn btn-primary search">搜索
	                        </button> </span>
	                    </div>
						<select class="form-control" name="userType" onchange="setParam()">
	                        <option value="-1">发送对象</option>
	                        <option value="0">全部</option>
	                        <option value="1">教师</option>
	                        <option value="2">学生</option>
	                    </select>
	                    <select class="form-control" name="isAudit" onchange="setParam()">
	                        <option value="-1">状态</option>
	                        <option value="1">已发布</option>
	                        <option value="0">未发布</option>
	                    </select>
					</div>
				</div>
				<div class="ibox">
					<div class="ibox-content">
						<table class="table table-bordered table-striped table-hover">
							<thead>
								<tr>
									<th width="30"><input type="checkbox"  class="i-checks" id="checkAll" name="input[]"></th>
									<th>标题</th>
									<th nowrap="nowrap">接收对象</th>
									<th nowrap="nowrap">点赞</th>
									<th nowrap="nowrap">评论</th>
									<th nowrap="nowrap">删除时间</th>
									<th nowrap="nowrap">发布状态</th>
									<th nowrap="nowrap">操作</th>
								</tr>
							</thead>
							<tbody id="listBox">
								<tr>
									<td colspan="8">
										<div class="loading"></div>
									</td>
								</tr>
							</tbody>
							<script type="html/text" id="artList">
								{{# for(var i = 0, len = d.list.length; i < len; i++){ }}
								    <tr>
										<td>
											<input type="checkbox" class="i-checks" name="checkbox" value="{{ d.list[i].info_id }}">
										</td>
										<td><a href="/html-article-detail.html?id={{ d.list[i].info_id }}"  class="J_menuItem">{{ d.list[i].title }}</a></td>
										<td nowrap="nowrap">{{ d.list[i].user_type==0?'全部': (d.list[i].user_type==1?'教师':'学生') }}</td>
										<td nowrap="nowrap">{{ d.list[i].like_count }}</td>
										<td nowrap="nowrap">{{ d.list[i].comment_count }}</td>
										<td nowrap="nowrap">{{ d.list[i].delete_time }}</td>
										<td nowrap="nowrap">{{ d.list[i].is_audit==0?'审核中':'已通过' }}</td>
										<td nowrap="nowrap">
											<a href="javascript:;" class="reply" data-id="{{ d.list[i].info_id }}"><i class="fa fa-mail-reply"></i>还原</a>
											<!--<a href="javascript:;" class="danger delete" data-id="{{ d.list[i].info_id }}"><i class="fa fa-close"></i>删除</a>-->
										</td>
									</tr>
								{{# } }}
							</script>
						</table>
						<div class="button-box">
							<button type="button" class="btn btn-primary multiple-reply"><i class="fa fa-mail-reply"></i>还原</button>
							<!-- <button type="button" class="btn btn-danger multiple-delete"><i class="fa fa-close"></i>删除</button> -->
							<div class="page f_r" id="page"></div>
							<div class="f_r count" id="count"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		$(function () {
			$(".search").on("click", function () {
				setParam();
			});
			$("input[name='keywords']").on("keypress", function (e) {
				if(e.keyCode == 13) {
					setParam();
				}
			});
			// 单个删除
			$("table").on("click", ".delete", function () {
				var id = $(this).data("id");
				var param = {ids: id, type: 1};
				$.deleteNode("Trash/delete", param, '确定要删除此条资讯吗？', function (data) {
					if(data.status == 1){
						setParam();
					} else {
						layer.alert(data.msg);
						return false;
					}
				});
			});
			// 多个删除
			$(".multiple-delete").on("click", function () {
				var ids = [];
				$("input[name='checkbox']:checked").each(function(){
			    	ids.push($(this).val());
		    	});
		    	var id = ids.join(",");
		    	var param = {ids: id, type: 1};
				$.deleteNode("Trash/delete", param, '确定要删除所选资讯吗？', function (data) {
					if(data.status == 1){
						setParam();
					} else {
						layer.alert(data.msg);
						return false;
					}
				});
			});

			// 单个还原
			$("table").on("click", ".reply", function () {
				var id = $(this).data("id");
				var param = {ids: id, type: 1};
				$.replyNode("Trash/reduction", param, '确定要还原此条资讯吗？', function (data) {
					if(data.status == 1){
						setParam();
					} else {
						layer.alert(data.msg);
						return false;
					}
				});
			});
			// 多个还原
			$(".multiple-reply").on("click", function () {
				var ids = [];
				$("input[name='checkbox']:checked").each(function(){
			    	ids.push($(this).val());
		    	});
		    	var id = ids.join(",");
		    	var param = {ids: id, type: 1};
				$.replyNode("Trash/reduction", param, '确定要还原所选资讯吗？', function (data) {
					if(data.status == 1){
						setParam();
					} else {
						layer.alert(data.msg);
						return false;
					}
				});
			});
		});

		var param = {token: $.ROOT.getItem("token"), type: 1};
		setParam();

		function setParam () {
			var title = $("input[name='keywords']").val() || '';
			var userType = $("select[name='userType']").val();
			var isAudit = $("select[name='isAudit']").val();
			param['title'] = title;
			param['user_type'] = userType;
			param['is_audit'] = isAudit;
			return renderingPage();
		}

		function renderingPage(page){
			param['page'] = page || 1;
			$.ROOT.request("Content/index", param, function (data) {
				if($("#checkAll").prop("checked")){
					$("#checkAll").attr("checked", false);
				}
				if(data.status == 1){
					if(data.count > 0){
						$(".button-box").show();
						$("#checkAll").show();
						var pageNum = Math.ceil(data.count/10);
						$("#count").html("共"+pageNum+"页，"+data.count+"条");
				        //显示分页
				        laypage({
				            cont: 'page', //容器。值支持id名、原生dom对象，jquery对象。【如该容器为】：<div id="page1"></div>
				            pages: pageNum, //通过后台拿到的总页数
				            curr: page || 1, //当前页
				            skip: true, //是否开启跳页
				            jump: function(obj, first){ //触发分页后的回调
				                if(!first){ //点击跳页触发函数自身，并传递当前页：obj.curr
				                    renderingPage(obj.curr);
				                }
				            }
				        });
				        var gettpl = document.getElementById('artList').innerHTML;
						laytpl(gettpl).render(data, function(html){
						    document.getElementById('listBox').innerHTML = html;
						});
					} else {
						$(".button-box").hide();
						$("#checkAll").hide();
						$("#listBox").html('<tr><td colspan="8" align="center">暂无数据</td></tr>');
					}
				} else {
					layer.alert(data.msg);
					return false;
				}
			});
		};
	</script>
<script src="/statics/js/plugins/layer/layer.min.js"></script>
</body>

</html>